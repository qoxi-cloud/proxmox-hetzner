# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

source /etc/network/interfaces.d/*

auto lo
iface lo inet loopback

iface lo inet6 loopback

# === IFACE_MANUAL_START ===
# Physical interface (no IP, part of bridge)
auto {{INTERFACE_NAME}}
iface {{INTERFACE_NAME}} inet manual
# === IFACE_MANUAL_END ===

# === IFACE_STATIC_START ===
# Physical interface with host IP
auto {{INTERFACE_NAME}}
iface {{INTERFACE_NAME}} inet static
    address {{MAIN_IPV4}}/32
    gateway {{MAIN_IPV4_GW}}
    up sysctl --system

iface {{INTERFACE_NAME}} inet6 static
    address {{MAIN_IPV6}}/128
    gateway {{IPV6_GATEWAY}}
    accept_ra 2
# === IFACE_STATIC_END ===

# === VMBR0_EXTERNAL_START ===
# vmbr0: External bridge - VMs get IPs from router/DHCP
# Host IP is on this bridge
auto vmbr0
iface vmbr0 inet static
    address {{MAIN_IPV4}}/32
    gateway {{MAIN_IPV4_GW}}
    bridge-ports {{INTERFACE_NAME}}
    bridge-stp off
    bridge-fd 0
    up sysctl --system

iface vmbr0 inet6 static
    address {{MAIN_IPV6}}/128
    gateway {{IPV6_GATEWAY}}
    accept_ra 2
# === VMBR0_EXTERNAL_END ===

# === VMBR0_NAT_START ===
# vmbr0: Private NAT network for VMs
# All VMs connect here and access internet via NAT
# MTU 9000 (jumbo frames) for improved VM-to-VM performance
auto vmbr0
iface vmbr0 inet static
    address {{PRIVATE_IP_CIDR}}
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    mtu {{BRIDGE_MTU}}
    # NAT masquerade handled by nftables (/etc/nftables.conf)
    # CT zone for Proxmox bridge tracking (required for VM networking)
    post-up   iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
    post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1 || true

iface vmbr0 inet6 static
    address {{FIRST_IPV6_CIDR}}
# === VMBR0_NAT_END ===

# === VMBR1_START ===
# vmbr1: Private NAT network for VMs
# VMs connect here for isolated network with NAT to internet
# MTU 9000 (jumbo frames) for improved VM-to-VM performance
auto vmbr1
iface vmbr1 inet static
    address {{PRIVATE_IP_CIDR}}
    bridge-ports none
    bridge-stp off
    bridge-fd 0
    mtu {{BRIDGE_MTU}}
    # NAT masquerade handled by nftables (/etc/nftables.conf)
    # CT zone for Proxmox bridge tracking (required for VM networking)
    post-up   iptables -t raw -I PREROUTING -i fwbr+ -j CT --zone 1
    post-down iptables -t raw -D PREROUTING -i fwbr+ -j CT --zone 1 || true

iface vmbr1 inet6 static
    address {{FIRST_IPV6_CIDR}}
# === VMBR1_END ===
